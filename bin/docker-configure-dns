#!/usr/bin/env bash

while read network; do
    current_domains=$(networksetup -getsearchdomains "${network}" | tr '\n' ' ')

    if [ ! -z "$(echo ${current_domains} | grep "There aren't any Search Domains set on" )" ]; then
        current_domains=$(scutil --dns | sed -n "0,/nameserver/{s/ *search domain\[[0-9]*\] : \(.*\)/\1/p}" | tr '\n' ' ')
    fi

    if [ -z "$(echo ${current_domains} | grep "node.consul")" ]; then
        sudo networksetup -setsearchdomains "${network}" $current_domains node.consul
    fi
done < <(networksetup -listallnetworkservices | sed 1d)

restart=false

# docker machine now provides EXTRA_ARGS by default. So we need to extend it
if [ ! -z "$(docker-machine ssh dev "cat /var/lib/boot2docker/profile" | grep virtualbox)" ]; then
    echo "Dropping the original EXTRA_ARGS parameter"
    docker-machine ssh dev "cat /var/lib/boot2docker/profile | sed -e '1,5d' | sudo tee /var/lib/boot2docker/profile.new &&
        sudo mv /var/lib/boot2docker/profile /var/lib/boot2docker/profile.old &&
        sudo mv /var/lib/boot2docker/profile.new /var/lib/boot2docker/profile &&
        sudo /etc/init.d/docker restart" &>/dev/null
    restart=true
fi

if [ -z "$(docker-machine ssh dev "cat /var/lib/boot2docker/profile" | grep EXTRA_ARGS)" ]; then
    echo "Adding new EXTRA_ARGS parameter"
    docker-machine ssh dev "echo $'EXTRA_ARGS=\"
            --insecure-registry 172.18.0.0/16
            --insecure-registry 10.0.0.0/8
            --bip=172.30.254.1/24
        \"' | sudo tee -a /var/lib/boot2docker/profile &&
        sudo /etc/init.d/docker restart" &>/dev/null
    restart=true
fi

if [ $restart ]; then
    docker-machine stop dev
    docker-machine start dev
     . docker-dc dev
fi

if [ ! -d "/etc/resolver" ]; then
    sudo mkdir /etc/resolver
fi

echo "nameserver $(docker-machine ip dev)" | sudo tee /etc/resolver/consul &>/dev/null

current_dest=$(netstat -rn | sed -nr 's|^172.30.254/24\s*(\S*).*|\1|p')
if [ "$current_dest" != "$(docker-machine ip dev)" ]; then
    if [ ! -z "${current_dest}" ]; then
        sudo route -q delete '172.30.254.0/24'
    fi

    sudo route -q add '172.17.0.0/24' "$(docker-machine ip dev)"
fi
